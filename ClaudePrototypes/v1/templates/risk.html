{% extends "base.html" %}

{% block title %}Risk Analysis - Python for Finance{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-5 fw-bold">
                        <i class="bi bi-shield-exclamation me-3"></i>
                        Risk Analysis
                    </h1>
                    <p class="lead text-muted">Comprehensive Investment Risk Assessment</p>
                </div>
                <a href="{{ url_for('education') }}#risk" class="btn btn-outline-primary">
                    <i class="bi bi-question-circle me-2"></i>
                    Learn More
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 2rem;">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-gear-fill me-2"></i>
                        Analysis Parameters
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="riskForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-4">
                            <label for="{{ form.tickers.id }}" class="form-label fw-bold">
                                <i class="bi bi-list-ul me-2"></i>Stock Tickers
                            </label>
                            {{ form.tickers(class="form-control") }}
                            <div class="form-text">
                                Enter comma-separated ticker symbols for risk analysis
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label for="{{ form.start_date.id }}" class="form-label fw-bold">
                                    <i class="bi bi-calendar-event me-2"></i>Start Date
                                </label>
                                {{ form.start_date(class="form-control") }}
                            </div>
                            <div class="col-6">
                                <label for="{{ form.end_date.id }}" class="form-label fw-bold">
                                    <i class="bi bi-calendar-check me-2"></i>End Date
                                </label>
                                {{ form.end_date(class="form-control") }}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg" id="analyzeBtn">
                            <i class="bi bi-play-circle-fill me-2"></i>
                            Analyze Risk
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-lg-8">
            {% if results %}
                <!-- Key Risk Metrics -->
                <div class="row mb-4">
                    {% set portfolio_vol = results.diversification_analysis.portfolio_volatility %}
                    {% set avg_vol = results.diversification_analysis.average_individual_volatility %}
                    {% set div_ratio = results.diversification_analysis.diversification_ratio %}
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ (portfolio_vol * 100)|round(1) }}%</div>
                            <div class="metric-label">Portfolio Volatility</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ div_ratio|round(2) }}</div>
                            <div class="metric-label">Diversification Ratio</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ results.diversification_analysis.risk_reduction_percentage|round(1) }}%</div>
                            <div class="metric-label">Risk Reduction</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ results.correlation_analysis.average_correlation|round(3) }}</div>
                            <div class="metric-label">Avg Correlation</div>
                        </div>
                    </div>
                </div>

                <!-- Risk-Return Scatter -->
                <div class="chart-container">
                    <h4 class="mb-4">
                        <i class="bi bi-scatter-chart me-2"></i>
                        Risk-Return Profile
                    </h4>
                    <div id="riskReturnChart" style="height: 400px;"></div>
                </div>

                <!-- Correlation Heatmap -->
                <div class="chart-container">
                    <h4 class="mb-4">
                        <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                        Correlation Matrix
                    </h4>
                    <div id="correlationHeatmap" style="height: 400px;"></div>
                </div>

                <!-- Individual Risk Metrics -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-bar-chart-fill me-2"></i>
                            Individual Asset Risk Metrics
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Annual Volatility</th>
                                        <th>Downside Deviation</th>
                                        <th>Max Drawdown</th>
                                        <th>Skewness</th>
                                        <th>VaR (5%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticker in results.tickers %}
                                        {% set risk_data = results.individual_risks[ticker] %}
                                        <tr>
                                            <td><strong>{{ ticker }}</strong></td>
                                            <td>{{ (risk_data.annual_volatility * 100)|round(2) }}%</td>
                                            <td>{{ (risk_data.downside_deviation * 100)|round(2) }}%</td>
                                            <td class="text-danger">{{ (risk_data.max_drawdown * 100)|round(2) }}%</td>
                                            <td class="{% if risk_data.skewness < 0 %}text-danger{% else %}text-success{% endif %}">
                                                {{ risk_data.skewness|round(3) }}
                                            </td>
                                            <td class="text-danger">{{ (risk_data.percentiles['5%'] * 100)|round(2) }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Value at Risk Analysis -->
                {% if results.var_analysis %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Value at Risk (VaR) Analysis
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for confidence, var_data in results.var_analysis.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="border rounded p-3">
                                    <h5 class="text-primary">{{ confidence }} Confidence Level</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Daily VaR (Historical):</strong></td>
                                            <td class="text-danger">{{ (var_data.var_historical * 100)|round(2) }}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Daily VaR (Parametric):</strong></td>
                                            <td class="text-danger">{{ (var_data.var_parametric * 100)|round(2) }}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Expected Shortfall:</strong></td>
                                            <td class="text-danger">{{ (var_data.conditional_var * 100)|round(2) }}%</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Insights -->
                <div class="insights-section">
                    <h4 class="mb-4">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        Risk Analysis Insights
                    </h4>
                    {% for insight in results.insights %}
                        <div class="insight-item">
                            <i class="bi bi-arrow-right-circle-fill me-2"></i>
                            {{ insight }}
                        </div>
                    {% endfor %}
                </div>

            {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <div class="feature-icon text-muted mb-4">
                        <i class="bi bi-shield-exclamation" style="font-size: 5rem;"></i>
                    </div>
                    <h3 class="text-muted">Ready for Risk Analysis</h3>
                    <p class="lead text-muted">
                        Enter stock tickers to perform comprehensive risk analysis including 
                        volatility, correlation, and diversification metrics.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle form submission
    document.getElementById('riskForm').addEventListener('submit', function(e) {
        const btn = document.getElementById('analyzeBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
        btn.disabled = true;
    });

    {% if results %}
        // Risk-Return Scatter Plot
        const riskReturnData = [{
            x: {{ results.chart_data.risk_return_scatter.volatilities | safe }},
            y: {{ results.chart_data.risk_return_scatter.returns | safe }},
            text: {{ results.chart_data.risk_return_scatter.tickers | safe }},
            mode: 'markers+text',
            type: 'scatter',
            marker: {
                size: 12,
                color: '#3498db',
                line: { color: '#2980b9', width: 2 }
            },
            textposition: 'top center'
        }];

        const riskReturnLayout = {
            title: 'Risk vs Return Profile',
            xaxis: { title: 'Annual Volatility', tickformat: '.1%' },
            yaxis: { title: 'Annual Return', tickformat: '.1%' },
            showlegend: false,
            plot_bgcolor: 'white',
            paper_bgcolor: 'white'
        };

        Plotly.newPlot('riskReturnChart', riskReturnData, riskReturnLayout);

        // Correlation Heatmap
        const correlationMatrix = {{ results.correlation_analysis.correlation_matrix | safe }};
        const tickers = {{ results.tickers | safe }};
        
        const correlationData = [{
            z: tickers.map(ticker1 => 
                tickers.map(ticker2 => correlationMatrix[ticker1][ticker2])
            ),
            x: tickers,
            y: tickers,
            type: 'heatmap',
            colorscale: 'RdBu',
            zmid: 0,
            text: tickers.map(ticker1 => 
                tickers.map(ticker2 => 
                    correlationMatrix[ticker1][ticker2].toFixed(3)
                )
            ),
            texttemplate: '%{text}',
            textfont: { size: 12 }
        }];

        const correlationLayout = {
            title: 'Asset Correlation Matrix',
            plot_bgcolor: 'white',
            paper_bgcolor: 'white'
        };

        Plotly.newPlot('correlationHeatmap', correlationData, correlationLayout);
    {% endif %}
</script>
{% endblock %}
